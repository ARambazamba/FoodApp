name: FoodApi Docker Build
pool:
  vmImage: "ubuntu-20.04"
trigger:
  branches:
    include:
      - master
      - development
  paths:
    include:
      - FoodApi/*
variables:
  buildConfiguration: "Release"
  apiPath: "FoodApi/"
  dockerReg: "az400-m15acr"
  conARM: "az400-m015"
  imageName: "foodapi"
  appService: "foodapi-21482"

stages:
  - stage: "BuildApi"
    displayName: "Build Api Image"
    jobs:
      - job: "Build"
        steps:
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: $(dockerReg)

          - task: Docker@2
            displayName: Build and Push
            inputs:
              repository: $(imageName)
              command: buildAndPush
              Dockerfile: FoodApi/dockerfile
          - task: Docker@2
            displayName: Logout of ACR
            inputs:
              command: logout
              containerRegistry: $(dockerReg)

  - stage: "DeployApi"
    displayName: "Deploy Api Container"
    jobs:
      - job: "Deploy"
        steps:
          - task: AzureWebAppContainer@1
            inputs:
              azureSubscription: $(conARM)
              appName: $(appService)
              deployToSlotOrASE: true
              resourceGroupName: $(rg)
              slotName: "production"
              containers: "$(acr).azurecr.io/$(imageName)"
